name: Build Padavan for RM2100

on:
  workflow_dispatch:
    inputs:
      firmware_version:
        description: 'å›ºä»¶ç‰ˆæœ¬æ ‡è¯†'
        required: false
        default: 'clean'

env:
  REPOSITORY_URL: https://github.com/hanwckf/rt-n56u
  DEVICE_NAME: RM2100
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libtool-bin gperf python3-docutils autopoint gettext \
          unzip libtool gcc g++ gcc-multilib g++-multilib \
          libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev \
          cmake gawk fakeroot curl git xxd cpio pkg-config zlib1g-dev \
          bison flex texinfo automake help2man wget
        sudo timedatectl set-timezone "$TZ"

    - name: å…‹éš†æºç 
      run: |
        git clone --depth=1 $REPOSITORY_URL padavan
        cd padavan
        echo "COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV

    - name: åº”ç”¨çº¯å‡€é…ç½®
      run: |
        cd padavan/trunk
        
        # åˆ›å»ºçº¯å‡€é…ç½®æ–‡ä»¶
        cat > configs/templates/$DEVICE_NAME.config << 'EOF'
        ### Target Vendor/Product (support only Ralink RT3883/MT7620/MT7621/MT7628)
        CONFIG_VENDOR=Ralink
        CONFIG_PRODUCT=MT7621
        
        ### Target ProductID (board select, max 12 symbols)
        CONFIG_FIRMWARE_PRODUCT_ID="RM2100"
        
        ### Linux kernel and toolchain
        CONFIG_FIRMWARE_INCLUDE_SFE=y
        CONFIG_LINUXDIR=linux-4.4.x
        
        ############################################################
        ### Linux kernel configuration
        ############################################################
        
        ### Enable IPv6 support
        CONFIG_FIRMWARE_ENABLE_IPV6=y
        
        ### Enable USB support (disable for clean build)
        CONFIG_FIRMWARE_ENABLE_USB=n
        
        ### Include WiFi driver and firmware
        CONFIG_FIRMWARE_WIFI_DRIVER=5.0
        
        ############################################################
        ### Userspace configuration - DISABLE ALL non-essential
        ############################################################
        
        ### Include Web UI International Language Support
        CONFIG_FIRMWARE_INCLUDE_LANG_CN=y
        
        ### Disable all VPN/Proxy services
        CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n
        CONFIG_FIRMWARE_INCLUDE_SSSERVER=n
        CONFIG_FIRMWARE_INCLUDE_V2RAY=n
        CONFIG_FIRMWARE_INCLUDE_TROJAN=n
        CONFIG_FIRMWARE_INCLUDE_XRAY=n
        CONFIG_FIRMWARE_INCLUDE_TUNSAFE=n
        CONFIG_FIRMWARE_INCLUDE_WIREGUARD=n
        
        ### Disable adblock/DNS services
        CONFIG_FIRMWARE_INCLUDE_ADBYBY=n
        CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER=n
        CONFIG_FIRMWARE_INCLUDE_SMARTDNS=n
        CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=n
        
        ### Disable remote access/tunnel services
        CONFIG_FIRMWARE_INCLUDE_FRPC=n
        CONFIG_FIRMWARE_INCLUDE_FRPS=n
        CONFIG_FIRMWARE_INCLUDE_ZEROTIER=n
        CONFIG_FIRMWARE_INCLUDE_DDNSTO=n
        CONFIG_FIRMWARE_INCLUDE_ALIDDNS=n
        
        ### Disable file sharing services
        CONFIG_FIRMWARE_INCLUDE_SMBD=n
        CONFIG_FIRMWARE_INCLUDE_SMBD36=n
        CONFIG_FIRMWARE_INCLUDE_FTPD=n
        
        ### Disable authentication clients
        CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n
        CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n
        CONFIG_FIRMWARE_INCLUDE_SRELAY=n
        
        ### Disable multimedia/entertainment
        CONFIG_FIRMWARE_INCLUDE_WYY=n
        CONFIG_FIRMWARE_INCLUDE_WYYBIN=n
        
        ### Disable diagnostic/utility tools
        CONFIG_FIRMWARE_INCLUDE_TTYD=n
        CONFIG_FIRMWARE_INCLUDE_LRZSZ=n
        CONFIG_FIRMWARE_INCLUDE_HTOP=n
        CONFIG_FIRMWARE_INCLUDE_NANO=n
        CONFIG_FIRMWARE_INCLUDE_IPERF3=n
        CONFIG_FIRMWARE_INCLUDE_MTR=n
        CONFIG_FIRMWARE_INCLUDE_SOCAT=n
        
        ### Disable SDR/Radio tools
        CONFIG_FIRMWARE_INCLUDE_DUMP1090=n
        CONFIG_FIRMWARE_INCLUDE_RTL_SDR=n
        
        ### Disable advanced network services
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_CLIENT=n
        CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_CMD=n
        CONFIG_FIRMWARE_INCLUDE_VLMCSD=n
        CONFIG_FIRMWARE_INCLUDE_NAPT66=n
        
        ### Disable cloud storage drivers
        CONFIG_FIRMWARE_INCLUDE_ALDRIVER=n
        
        ### Disable additional SSL/SSH
        CONFIG_FIRMWARE_INCLUDE_OPENSSH=n
        CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n
        CONFIG_FIRMWARE_INCLUDE_OPENSSL_EC=n
        CONFIG_FIRMWARE_INCLUDE_DDNS_SSL=n
        CONFIG_FIRMWARE_INCLUDE_HTTPS=n
        EOF
        
        echo "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
        cat configs/templates/$DEVICE_NAME.config

    - name: ä¸‹è½½å¹¶è§£å‹å·¥å…·é“¾
      run: |
        cd padavan/toolchain-mipsel
        ./dl_toolchain.sh

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      run: |
        cd padavan/trunk
        ./clear_tree
        fakeroot ./build_firmware_modify $DEVICE_NAME

    - name: æ•´ç†ç¼–è¯‘äº§ç‰©
      if: success()
      run: |
        cd padavan/trunk/images
        mkdir -p $GITHUB_WORKSPACE/release
        
        for file in *.trx; do
          if [ -f "$file" ]; then
            NEW_NAME="${DEVICE_NAME}_${BUILD_DATE}_${COMMIT_HASH}.trx"
            cp "$file" $GITHUB_WORKSPACE/release/$NEW_NAME
            echo "FIRMWARE_FILE=$NEW_NAME" >> $GITHUB_ENV
            
            # ç”ŸæˆSHA256
            cd $GITHUB_WORKSPACE/release
            sha256sum $NEW_NAME > ${NEW_NAME}.sha256
            echo "å›ºä»¶ç¼–è¯‘å®Œæˆ: $NEW_NAME"
          fi
        done

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Padavan_${{ env.DEVICE_NAME }}_${{ env.BUILD_DATE }}
        path: release/*
        retention-days: 7

    - name: åˆ›å»ºReleaseå‘å¸ƒ
      if: success() && github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.BUILD_DATE }}
        name: çº¢ç±³AC2100çº¯å‡€å›ºä»¶ ${{ env.BUILD_DATE }}
        body: |
          ## ğŸ“¦ çº¢ç±³AC2100 (RM2100) Padavançº¯å‡€å›ºä»¶
          
          ### ğŸ”§ ç¼–è¯‘ä¿¡æ¯
          - **è®¾å¤‡å‹å·**: Redmi AC2100 (RM2100)
          - **ç¼–è¯‘æ—¶é—´**: ${{ env.BUILD_DATE }}
          - **æºç ç‰ˆæœ¬**: hanwckf/rt-n56u@${{ env.COMMIT_HASH }}
          - **å†…æ ¸ç‰ˆæœ¬**: Linux 4.4.x
          - **å›ºä»¶ç±»å‹**: çº¯å‡€ç‰ˆ,æ— ç¬¬ä¸‰æ–¹æ’ä»¶
          
          ### âœ¨ å›ºä»¶ç‰¹æ€§
          - âœ… åŸºç¡€è·¯ç”±åŠŸèƒ½å®Œæ•´
          - âœ… IPv6åŸç”Ÿæ”¯æŒ
          - âœ… SFEç¡¬ä»¶åŠ é€Ÿ(Shortcut Forwarding Engine)
          - âœ… MT7621 SoC + MT7603E/MT7612Eæ— çº¿é©±åŠ¨
          - âŒ å·²ç§»é™¤æ‰€æœ‰ç¬¬ä¸‰æ–¹æ’ä»¶(SS/V2Ray/Adbyby/Zerotierç­‰)
          - âŒ å·²ç§»é™¤æ–‡ä»¶å…±äº«(Samba/FTP)
          - âŒ å·²ç§»é™¤SSH/Telnetå·¥å…·
          
          ### ğŸ“‹ åˆ·æœºè¯´æ˜
          1. è·¯ç”±å™¨è¿›å…¥Breed/UBOOTæ§åˆ¶å°
          2. é€‰æ‹©å›ºä»¶æ›´æ–°
          3. ä¸Šä¼  `.trx` æ–‡ä»¶
          4. ç­‰å¾…åˆ·å†™å®Œæˆå¹¶é‡å¯
          5. é»˜è®¤IP: 192.168.2.1 | ç”¨æˆ·å: admin | å¯†ç : admin
          
          ### ğŸ” SHA256æ ¡éªŒ
          ```
          $(cat release/*.sha256)
          ```
          
          ---
          âš ï¸ **è­¦å‘Š**: æ­¤ä¸ºçº¯å‡€å›ºä»¶,ä»…é€‚åˆéœ€è¦ç¨³å®šè·¯ç”±åŠŸèƒ½çš„ç”¨æˆ·ä½¿ç”¨
        files: release/*
