name: Build Redmi AC2100 Padavan (Fixed)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: '选择固件版本 / Firmware Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (hanwckf - Stable/Legacy)'
          - '4.4 (MeIsReallyBa - Kernel 4.4)'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo
        sudo apt-get clean

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 1. 定义变量与路径 (使用当前工作区，不使用 /opt)
        # =======================================================
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
          REPO_URL="https://github.com/hanwckf/rt-n56u.git"
          REPO_BRANCH="master"
          echo "Selected Version: 3.4 (hanwckf)"
        else
          REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
          REPO_BRANCH="main"
          echo "Selected Version: 4.4 (MeIsReallyBa)"
        fi
        
        TARGET_DEVICE="RM2100"
        
        # =======================================================
        # 2. 拉取源码 & 准备 Toolchain
        # =======================================================
        echo "Cloning source code..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        echo "Preparing Toolchain..."
        cd $WORK_DIR/toolchain-mipsel
        # 使用源码自带脚本下载 toolchain，这是最稳妥的
        sh dl_toolchain.sh
        
        # =======================================================
        # 3. 配置文件修改 (Modifying Config)
        # =======================================================
        cd $WORK_DIR/trunk
        
        # 定位模板文件
        TEMPLATE_PATH="configs/templates/$TARGET_DEVICE.config"
        if [ ! -f "$TEMPLATE_PATH" ]; then
          echo "Error: Template config $TEMPLATE_PATH not found!"
          ls -R configs/templates
          exit 1
        fi
        
        echo "Applying customization to $TEMPLATE_PATH..."
        
        # --- 净化插件 (Purge Plugins) ---
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_WGET=y/CONFIG_FIRMWARE_INCLUDE_WGET=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SSSERVER=y/CONFIG_FIRMWARE_INCLUDE_SSSERVER=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=y/CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_XRAY=y/CONFIG_FIRMWARE_INCLUDE_XRAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_V2RAY=y/CONFIG_FIRMWARE_INCLUDE_V2RAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $TEMPLATE_PATH
        
        # --- 性能优化 (Performance) ---
        # 强制开启 Flow Offload (硬件NAT)
        sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $TEMPLATE_PATH
        # 如果文件中原本没有这行，强制追加
        if ! grep -q "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD" $TEMPLATE_PATH; then
           echo "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y" >> $TEMPLATE_PATH
        fi
        
        # =======================================================
        # 4. 生成 .config 并验证 (CRITICAL FIX)
        # =======================================================
        echo "Copying template to .config..."
        cp -f $TEMPLATE_PATH .config
        
        # 强制检查：如果 .config 不存在，立刻报错停止，不浪费时间
        if [ ! -f .config ]; then
          echo "FATAL ERROR: .config file was not created successfully!"
          exit 1
        fi
        
        # 打印 .config 信息以供调试
        echo "Debug: .config exists. Size info:"
        ls -l .config
        echo "Debug: Checking FlowOffload setting in final .config:"
        grep "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD" .config
        
        # =======================================================
        # 5. 执行编译
        # =======================================================
        echo "Starting Build Process..."
        
        # 警告：绝对不要在这里运行 ./clear_tree，它会删除我们刚生成的 .config
        
        # 直接调用核心构建脚本，跳过可能出错的 wrapper
        fakeroot ./build_firmware
        
    - name: Organize & Upload Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: Padavan-RM2100-${{ inputs.target_version }}
        path: ${{ github.workspace }}/padavan/trunk/images/*.trx
